<html>
	<head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
		<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<link rel="stylesheet" href="bootstrap-4.4.1-dist\css\bootstrap.min.css">
		
	</head>
	
	<body>
		<div class="container mt-3 " >
			<div class="row ">
				<div class="col-4" >
					<div class="row alert alert-primary justify-content-center" "role="alert" style="margin-bottom: 0rem;">
						Circuit
						
					</div>
					
					<div class="row h-75">
						<textarea  class="form-control" id="circuit" placeholder="Input your circuit.&#10;&#10;I:xxx set input as xxx Ex: I:001 input：001,&#10;I:D01, 'D' mean don't care, input : 001 and 101. &#10;&#10;M:xxx measure bit Ex: M:12 measure 1 and 2 bit ( from up to down )." required></textarea>
					</div>
				</div>
				
				<div class="col mr-2 ">
					<table class="table text-center " role="alert">
						<thead class="table-danger" >
							<tr>
								<th scope="col"> Input </th>
								<th scope="col"> Image </th>
								<th scope="col">Description </th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<th scope="col">0</th>
								<th><img src="image\cb0.png"></th>
								<th scope="col">Control bit (low level trigger)</th>
							</tr>
							
							<tr>
								<th scope="col">1</th>
								<th><img src="image\cb1.png"></th>
								<th scope="col">Control bit (high level trigger)</th>
							</tr>
							
							<tr>
								<th scope="col">2</th>
								<th><img src="image\cpb.png"></th>
								<th scope="col">Wire gate</th>
							</tr>
							
							<tr>
								<th scope="col">3</th>
								<th><img src="image\nb.png"></th>
								<th scope="col">NOT-gate
									Note that each line must contain exactly one NOT-gate.</th>
							</tr>
							
							<tr>
								<th scope="col">H</th>
								<th><img src="image\ham.png"></th>
								<th scope="col">
									Just hadamard.</th>
							</tr>
						</tbody>
					</table>
					
				</div>
				
			</div>
			
			<div class="row mt-2" style="text-align:left; margin: auto;">
				<div class="col-2 mr-2">
					<button class="btn btn-primary" onclick="run()">Run</button>
					<button class="btn btn-danger" onclick="reset()">Clear</button>

				</div>
				<div class="col-2 mr-2" >
					<div class="form-check">
					  <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault1" checked>
					  <label class="form-check-label" for="flexRadioDefault1">
						Matrix
					  </label>
					</div>
					<div class="form-check">
					  <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault2" >
					  <label class="form-check-label" for="flexRadioDefault2">
						Ket
					  </label>
					</div>
				</div>
				<div class="col-2 mr-3"  style="border:1px solid transparent; border-radius:0.25rem; margin-bottom: 1rem; color: #818182; background-color: #fefefe; border-color: #fdfdfe; padding: 0.4rem;">
					<p id="gate_count">Gate count ：  </p>
				</div>
				
			</div >
			
			<div class="row mt-1 text-center">
				<div class="col-4 mr-3" >
					<div class="row alert alert-warning justify-content-center" "role="alert" style="margin-bottom: 0rem;">
						Result
					</div>
					<div class="formula" style="overflow:auto;height:360px;width:104%;">
						<div>
							<label id="truth_table" name="truthTable"  ></label>
						</div>
						
					</div>
				</div>
				<div class="col mr-2 text-center"  id="canvasFrame">
					<div class="row alert alert-success justify-content-center" "role="alert" style="margin-bottom: 0rem;">
						Circuit diagram
					</div>
					
					<div class="row text-center" style="overflow: auto;">
						<canvas id="mycanvas" width="0px" height="0px" style="margin:auto; background:#FFFFFF; text-align:center;">
							
						</canvas>
					</div>
					
				</div>
				
			</div>
			
			<div class="row alert alert-info justify-content-center" "role="alert" style="margin-bottom: 1em;margin-top:1em;">
				Probability
						
			</div>
			<canvas id="chart" width="50%" height="20%" style="margin:auto; background:#FFFFFF; text-align:center;">
							
			</canvas>
			
		</div>
	</body>
	
	
	
	<script>
		
		var canvas1 = document.getElementById('chart');
		var ctx3 = canvas1.getContext('2d');
		
		var data = {labels:[],
				datasets:[{
					label:'',
					data: [],
					backgroundColor:[],
					borderColor:[],
					borderWidth: 1
				}]};
		
		var chart = new Chart(ctx3, {
				type: 'bar',
				data:data,
				options: {
					scales: {
						yAxes: [{
							ticks: {
								min: 0,
								max: 100
							}
						}]
					}
				}
		});
		
		function reset(){
			//window.location.reload(); 
			var c= document.getElementById("mycanvas");
			var cxt=c.getContext("2d");
			cxt.clearRect(0,0,c.width,c.height);
			
			
			data = {labels:[],
				datasets:[{
					label:'',
					data: [],
					backgroundColor:[],
					borderColor:[],
					borderWidth: 1
			}]};
			chart.config.data = data;
			chart.update();
			
			document.getElementById("circuit").value="";
			document.getElementById("gate_count").innerHTML="Gate count ： ";
			document.getElementById("truth_table").innerText="";
		
		}
	
		function run(){
			var gate_number=0;
			var bit_number=0;
			var answer = [];
			var hadamard = [[1,1],[1,-1]];
			var I = [[1,0],[0,1]];
			var one = [0,1];
			var zero = [1,0];
			var han = [];
			var center = 0;
			
			var bit_gate = document.getElementById("circuit").value.split(' ');

			gate_number = bit_gate.length;
			
			/*if (bit_gate[gate_number-1] == ''){
				gate_number-=1;
			}*/
			
			
			var m_bit = [];
			if (bit_gate[gate_number-1][0] == 'M'){
				for(var i=2;i<bit_gate[gate_number-1].length;i++){
					m_bit.push(bit_gate[gate_number-1][i]);
				}
				gate_number -=1;
			}
			else{
				for(var i=0;i<bit_gate[gate_number-1].length;i++){
					m_bit.push((i+1));
				}
			}
			
			var check = [];
			var aa = document.getElementById("gate_count");
			if (bit_gate[0][0] == 'I'){
				center+=1;
				gate_number-=1;
				aa.innerHTML = "Gate count ： "+gate_number;
			} 
			else{
				if (bit_gate[gate_number-1] == ''){
					gate_number-=1
					aa.innerHTML = "Gate count ： "+gate_number;
				}
				else{
					aa.innerHTML = "Gate count ： "+gate_number;
				}
				
			}
			
			if (bit_gate[gate_number] != ''){
				bit_number = bit_gate[center].length;
			}
			
			
			
			
			var bit_gate2 = new Array(gate_number);
			
			if (center == 1){
				for (var i = center; i < gate_number+1; i++) {
					bit_gate2[i-1] = new Array(bit_number);
					for(var j=0;j<bit_number;j++){
						bit_gate2[i-1][j] = bit_gate[i][j];
					}
				}
			}
			else{
				for (var i = 0; i < gate_number; i++) {
					bit_gate2[i] = new Array(bit_number);
					for(var j=0;j<bit_number;j++){
						bit_gate2[i][j] = bit_gate[i][j];
					}
				}
			}
			
			var bb = document.getElementById("truth_table");
			bb.innerText = '';
			bb.innerText+='$$\\begin{aligned}';
			
			var k=0;
			
			var number = new Array(bit_number);
			var answer2 = [];
			
			var bit_gate3 = new Array(gate_number);
			for(var j=0;j<gate_number;j++){
				for (var p=0;p<bit_gate2[j].length;p++){
					if (bit_gate2[j][p] == 'H' && p==0){
						han = hadamard;
					}
					else if(bit_gate2[j][p] == '2' && p==0){
						han = I;
					}
					else if (bit_gate2[j][p] == 'H'){
						han = closes_d(han,hadamard);
					}
					else if (bit_gate2[j][p] == '2'){
						han = closes_d(han,I);
					}
					else if(bit_gate2[j][p] == '3'){
						han = set_not_gate(bit_number,bit_gate2[j]);
						break;
					}
				}
				bit_gate3[j]=han;
				han = [];
			}
			
			
			for( var i=0;i<Math.pow(2,bit_number);i++){
				
				k=i;
				
				answer = [];
				for(var j=0;j<bit_number;j++){
					number[j] = 0
					number[j] =  parseInt(k % 2);
					k = parseInt(k/2);			
				}
				var run_number = 0;
				if (center == 1){
					for(var j=bit_number-1 ;j>=0;j--){
						if (bit_gate[0][bit_number+1-j] == '0' && number[j] == '1' || bit_gate[0][bit_number+1-j] == '1' && number[j] == '0'){
							run_number = 1;
						}
					}
				}
				if (run_number == 0 && bit_number != 0){
					for(var j=bit_number-1 ;j>=0;j--){
						bb.innerText += number[j];
						if (j==bit_number-1){
							if(number[j] == 1){
								answer = one;
							}
							else{
								answer = zero;
							}
						}
						else{
							if (number[j] == 1){
								answer = closes(answer,one);
							}
							else{
								answer = closes(answer,zero);
							}
						}
					}
					
					bb.innerText += '&=';
					bb.innerText += output_(answer);
					
					
					for(var j=0;j<gate_number;j++){
						k=0;
						bb.innerText += '\\\\&=';
						/*for (var p=0;p<bit_gate2[j].length;p++){
							if (bit_gate2[j][p] == 'H' && p==0){
								han = hadamard;
							}
							else if(bit_gate2[j][p] == '2' && p==0){
								han = I;
							}
							else if (bit_gate2[j][p] == 'H'){
								han = closes_d(han,hadamard);
							}
							else if (bit_gate2[j][p] == '2'){
								han = closes_d(han,I);
							}
							else if(bit_gate2[j][p] == '3'){
								han = set_not_gate(bit_number,bit_gate2[j]);
								break;
							}
						}*/
						answer = matrix_dot(bit_gate3[j],answer);
						//han = [];
						
						bb.innerText += output_(answer);
						
					}
					answer2.push(answer);
					bb.innerText+= '\\\\'+'\\\\';
				}
				
			}
			//var nn=2;
			//bb.innerText = '$$\\begin{aligned} 2x - 4 &= 6 \\\\ 2x &= 10 \\\\ x &= 5  \\end{aligned}$$';
			bb.innerText+='\\end{aligned}$$'
			if (bit_number == 0){
				bb.innerText = '';
			}
			
			//bb.innerText = bit_gate3[0];
			draw(bit_number,bit_gate2,gate_number);
			if (gate_number!=0){
				measure(m_bit,answer2,bit_number)
			}
			
			MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
		}
		
		function measure(m_bit,answer,bit_number){
			
			var m_result = new Array(Math.pow(2,m_bit.length));
			for (var i=0;i<Math.pow(2,m_bit.length);i++){
			
				m_result[i] = 0; 
			}
			var d = '';
			var a=0;
			var b=0;
			for (var k=0;k<answer.length;k++){
				for(var i=0;i<Math.pow(2,bit_number);i++){
					if (answer[k][i] == '1'||answer[k][i] == '-1'){
						d = ToBin(i);
						while(Math.pow(2,d.length)< Math.pow(2,bit_number)){
							d = '0'+ d;
						}
						for(var j=0;j<m_bit.length;j++){
							if (d[m_bit[j]-1] == '0'){
								a+=0;		
							}
							else if(d[m_bit[j]-1] == '1'){
								a+=Math.pow(2,m_bit.length-1-j);
							}
						}
						m_result[a] +=1;
						b+=1
						a=0;
					}
					
				}
			}
			
			
			var m_name = new Array(Math.pow(2,m_bit.length));
			
			var m_bg_color = new Array(Math.pow(2,m_bit.length));
			
			var m_b_color = new Array(Math.pow(2,m_bit.length));
			
			for(var i=0;i<Math.pow(2,m_bit.length);i++){
				m_result[i] =  m_result[i]/b*100;
				d = ToBin(i);
				while(Math.pow(2,d.length)< Math.pow(2,m_bit.length)){
					d = '0'+ d;
				}
				m_name[i] = d;
				
				m_bg_color[i] = 'rgba(255, 99, 132, 0.2)';
				m_b_color[i] = 'rgba(255,99,132,1)';
			}
			
			data = {
				labels:m_name,
				datasets:[{
					label:'Probability',
					data: m_result,
					backgroundColor:m_bg_color,
					borderColor:m_b_color,
					borderWidth: 1
				}]
			};
			
			chart.config.data = data;
			chart.update();
			/*var chart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: m_name,
					datasets: [{
						label: 'Probability',
						data: m_result,
						backgroundColor:m_bg_color,
						borderColor:m_b_color,
						borderWidth: 1
					}]
				},
				
			});*/
			/*var bb = document.getElementById("truth_table");
			bb.innerText=m_result;*/
		}
		
		function draw(bit_number,bit_gate2,gate_number){
			var canvas = document.getElementById('mycanvas');
			
			//正中間350
			var w = 60;
			var h = 50;
			var t = 24;
			var ctx = canvas.getContext("2d");
			
			canvas.width = t+w*gate_number;
			canvas.height = t+h*bit_number;
			
			
			for (var i=0;i<bit_number;i++){
				ctx.beginPath();
				ctx.moveTo(t/3,t/3+h*(i+1));
				ctx.lineTo(t/3+w*gate_number,t/3+h*(i+1));
				ctx.strokeStyle = 'black';
				ctx.stroke();
				for (var j=0; j<gate_number;j++){
					ctx.beginPath();
					ctx.moveTo(t/3+w*(j+0.5),t/3+h*(i+1));
					ctx.lineTo(t/3+w*(j+0.5),t/3+h*bit_number);
					ctx.strokeStyle = 'black';
					ctx.stroke();
					
					if (bit_gate2[j][i] == '0'){
						ctx.beginPath();
						ctx.arc(t/3+w*(j+0.5), t/3+h*(i+1), 8, 0,Math.PI*2, true);
						ctx.fillStyle = "white";
						ctx.fill();
						ctx.stroke();
					}
					else if(bit_gate2[j][i] == '1'){
						ctx.beginPath();
						ctx.arc(t/3+w*(j+0.5), t/3+h*(i+1), 8, 0,Math.PI*2, true);
						ctx.fillStyle = "black";
						ctx.fill();
						
						ctx.stroke();
					}
					else if(bit_gate2[j][i] == '3'){
					
						ctx.beginPath();
						ctx.moveTo(t/3+w*(j+0.5),t/3+h*(i+1)-11);
						ctx.lineTo(t/3+w*(j+0.5),t/3+h*(i+1)+11);
						ctx.strokeStyle = 'black';
						ctx.stroke();
					
						ctx.beginPath();
						ctx.arc(t/3+w*(j+0.5), t/3+h*(i+1), 11, 0,Math.PI*2, false);
						ctx.strokeStyle = 'black';
						ctx.stroke();
						
						
					}
					else if(bit_gate2[j][i] == 'H'){
						ctx.beginPath();
						ctx.strokeRect(t/3+w*(j+0.5)-11, t/3+h*(i+1)-11, 22, 22);
						ctx.clearRect(t/3+w*(j+0.5)-11, t/3+h*(i+1)-11, 22, 22);
						ctx.font = "20px Arial"
						ctx.fillStyle='black';
						ctx.fillText("H", t/3+w*(j+0.5)-7.5, t/3+h*(i+1)+7.5);
						ctx.stroke();
						
					}
				}
			}
		}
		
		function closes(array2,array){
			let b = [];
			for (var i=0; i<array2.length;i++){
				for (var j=0;j<array.length;j++){
					b.push(array[j]*array2[i]);
				}
			}
				
			return b;
		
		}
		
		function closes_d(array1,array2){
			let a = [];
			let b = [];
			for (var k=0;k<array1.length;k++){
				for(var p=0;p<array2.length;p++){
					for(var i=0;i<array1[k].length;i++){
						for(var j=0;j<array2[p].length;j++){
							a.push(array1[k][i]*array2[p][j]);
						}
					}
					b.push(a);
					a=[];
				}
			
			}
								 
			return b 
		}
		
		function output_(answer){
			a=0
			b='';
			var mode = document.getElementById("flexRadioDefault1");
			for(var i=0;i<answer.length;i++){
				if (Math.abs(answer[i])>0){
					a+=1
					answer[i] /= Math.abs(answer[i]);	
				}
			} 
			
			if (mode.checked == true){
				if (a==1){
					return ('['+answer+']');
				}
				else{
					return ('\\frac{1}{\\sqrt{'+a.toString()+'}}'+'['+answer+']')
				}
			}
			else{
			
				if (a!=1){
					b+= '\\frac{1}{\\sqrt{'+a.toString()+'}}(';
				}
				c=0;
				d='';
				for(var i=0;i<answer.length;i++){
					if (answer[i] == -1){
						
						d = ToBin(i);
						while(Math.pow(2,d.length)< answer.length){
							d = '0'+ d;
						}					
						if (c==0){
							c+=1
							b += '-|'+ d +'〉';
						}
						else{
							b += '-|'+ d +'〉';
						}
					}
					else if (answer[i] == 1){
						
						d = ToBin(i);
						while(Math.pow(2,d.length)< answer.length){
							d = '0'+ d;
						}
					
						if (c==0){
							c+=1;
							b += '|'+ d +'〉';
						}
						else{
							b += '+|'+ d +'〉';
						}
					}
				}
			}
			
			if (a!=1){
				b+=')';
			}
			return b;	
		}	
		
		function ToBin (number) {
			let num = number;
			let binary = (num % 2).toString();
			for (; num > 1; ) {
				num = parseInt(num / 2);
				binary =  (num % 2) + (binary);
			}
			return binary;
		}
		
		function set_not_gate(bit_number,gate){
			let a=[],b=[];
			var k = new Array(Math.pow(2,bit_number)).fill(0);
			
			for (var i=0;i<Math.pow(2,bit_number);i++){
				k[i] = new Array(Math.pow(2,bit_number)).fill(0);
			}
			
			for (var i=0;i<Math.pow(2,bit_number);i++){
				var bb = i;
				for (var j=0;j<bit_number;j++){
					a.push(parseInt(bb%2));
					bb/=2;
				}
				var c=0;
		
				for(var j=0;j<bit_number;j++){
					if ((a[j]==1 && gate[bit_number-1-j] == 0) || (a[j] == 0 && gate[bit_number-1-j] == 1)){
						c=1;
					}
				}
				
				for(var j=0;j<bit_number;j++){
					if (gate[j]==3 && c==0){
						if (a[bit_number-1-j] == 0){
							a[bit_number-1-j] = 1;
						}
						else{
							a[bit_number-1-j] = 0;
						}
					}
				}
				c=0;
				for(var j=0;j<bit_number;j++){
					c+=Math.pow(2,j)*a[j];
				}
				b.push(c);
				a=[];
			}
			for (var i=0;i<Math.pow(2,bit_number);i++){
				for (var j=0;j<Math.pow(2,bit_number);j++){
					if (b[j] == i){
						k[i][j] = 1;
					}
				}
			}
			return k;
		}

		
		function matrix_dot(array1,array2){
			
			var a=[];
			var c=0;
			for (var i=0;i<array1.length;i++){
				for (var j=0;j<array2.length;j++){
					c+=array1[i][j]*array2[j];
				}
				a.push(c);
				c=0;
			}
			return a;
		}
	</script>

</html>

